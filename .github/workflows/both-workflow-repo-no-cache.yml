# File name: .github/workflows/both-workflow-repo-no-cache.yml

# ======================================================================================
# NOTE: DO NOT RENAME THIS FILE.
# The workflow ID "both-workflow-repo-no-cache.yml" is required for the SaaS integration.
# This workflow builds the project directly from this repository's source code.
# ======================================================================================

name: Capacitor/Cordova Build Android/iOS Service (No-Cache)

on:
  # Manual trigger invoked by the SaaS Server
  workflow_dispatch:
    inputs:
      appBaseUrl:
        required: true
      buildId:
        required: true
      imageName:
        description: 'The name of the build engine image'
        required: true
        default: 'cordova-build-android-engine'
      ref:
        description: 'The image tag to use for the build engine'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # Required for secure OIDC authentication
      contents: write   # Required to checkout the repository code

    steps:
      # 1. Checkout the source code from THIS repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Log in to GHCR to pull the build engine (prevents rate limiting)
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # 3. Generate temporary identity token for secure server authentication
      # https://docs.github.com/en/actions/concepts/security/openid-connect
      - name: Get GitHub OIDC Token
        id: get_token
        run: |
          AUDIENCE=${{ inputs.appBaseUrl }}
          OIDC_TOKEN=$(curl -sfL -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${AUDIENCE}" | jq -r .value)
          echo "token=${OIDC_TOKEN}" >> $GITHUB_OUTPUT
      
      # 4. Execute the build engine (Clean Build)
      # NOTE: If using Secrets, they must be named exactly: KEYSTORE_BASE64, KEYSTORE_PASSWORD, KEY_ALIAS, KEY_PASSWORD
      # Required for uploading artifacts to GitHub Releases (Repo Storage Option) -e GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \ # auto
      # https://docs.github.com/en/repositories/releasing-projects-on-github/about-releases
      - name: Cordova Run Build Android/iOS Engine
        run: |
          docker run --rm -i \
            -e INPUT_APPBASEURL=${{ inputs.appBaseUrl }} \
            -e INPUT_BUILDID=${{ inputs.buildId }} \
            -e GITHUB_OIDC_TOKEN=${{ steps.get_token.outputs.token }} \
            -e GITHUB_SERVER_URL=${{ github.server_url }} \
            -e GITHUB_REPOSITORY=${{ github.repository }} \
            -e GITHUB_RUN_ID=${{ github.run_id }} \
            -e GITHUB_SHA=${{ github.sha }} \
            -e GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
            -e INPUT_KEYSTORE_BASE64=${{ secrets.KEYSTORE_BASE64 }} \
            -e INPUT_KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }} \
            -e INPUT_KEY_ALIAS=${{ secrets.KEY_ALIAS }} \
            -e INPUT_KEY_PASSWORD=${{ secrets.KEY_PASSWORD }} \
            -v ${{ github.workspace }}:/github/workspace \
            ghcr.io${{ github.event.inputs.imageName }}:${{ github.event.inputs.ref }}
